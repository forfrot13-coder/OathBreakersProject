OathBreakersProject — مرور پروژه

مکان: h:/Django/OathBreakersProject

1) ساختار سطح بالا
- manage.py : رابط خط فرمان Django
- oathbreakers/ : تنظیمات و پیکربندی پروژه
    - __init__.py
    - settings.py : پیکربندی (DB از طریق متغیرهای محیطی، DEBUG، MEDIA)
    - urls.py : مسیریابی ریشه (landing، admin، include برای API)
    - wsgi.py, asgi.py : سرورهای برنامه

- game/ : اپ اصلی حاوی منطق بازی
    - __init__.py
    - admin.py
    - apps.py
    - models.py : مدل‌های بازی (Avatar، PlayerProfile، Pack، CardTemplate، UserCard، MarketListing)
    - serializers.py : سریالایزرهای DRF
    - views.py : اندپوینت‌های تابعی (auth، market، packs، open_pack، exchange، profile و غیره)
    - views_viewsets.py : ViewSetهای DRF برای منابعی مثل profiles، user-cards، market
    - urls.py : الگوهای URL اپ (مسیرهای تابعی و router تحت /api/)
    - tests.py
    - migrations/ : فایل‌های مهاجرت
    - static/game/ : فایل‌های استاتیک (css، js، images)
    - templates/game/ : قالب‌های فرانت‌اند (index.html، login.html، register.html، welcome.html و کامپوننت‌ها)

- media/ : فایل‌های آپلود شده (avatars، cards، packs)
- requirements.txt : وابستگی‌های پایتون

2) خلاصهٔ نحوهٔ سرویس‌دهی صفحات و API
- صفحات فرانت‌اند از قالب‌های Django در `game/templates/game/` ارائه می‌شوند و توسط viewهای داخل `game/views.py` مصرف می‌گردند:
    - صفحهٔ فرود: `/` -> نمایش `welcome.html`
    - ورود: `/login/` -> `login.html`
    - ثبت‌نام: `/register/` -> `register.html`
    - رابط بازی (SPA-like): `/api/game/` که قالب `index.html` را استفاده می‌کند

- فضای نام REST API: `/api/game/` شامل مواردی مانند:
    - احراز هویت: `auth/register/`، `auth/login/`، `auth/logout/`
    - پروفایل: `profile/me/`، `profile/update/`
    - کارت‌ها: `my-cards/`، `open-pack/` (POST با اختیاری `pack_id`)
    - بازار: `market/` (نمایش لیست‌های فعال)
    - بسته‌ها: `packs/` (نمایش بسته‌های قابل خرید)
    - تبدیل ارز: `exchange/` (POST، تبدیل coins -> gems)
    - سایر: `claim/` (دریافت سکه‌های ماین شده)، `equip/` (تجهیز کارت در اسلات)
    - Router DRF: `/api/game/api/...` برای viewsetها (user-cards، profiles، market)

3) رفتارهای کلیدی (خلاصه)
- ثبت‌نام: ساخت `User` و `PlayerProfile` با منابع اولیه و صدور یک `UserCard` استارتر.
- باز کردن بسته‌ها: دریافت `pack_id` اختیاری، کسر هزینه متناسب با `currency_type`، تولید `UserCard` بر اساس `CardTemplate` و منطق rarity.
- لیست‌های بازار: فروشندگان `UserCard` را با `price_gems` لیست می‌کنند؛ خریدها با `select_for_update()` و `transaction.atomic()` محافظت می‌شوند.
- تبدیل سکه به جم: بسته‌های 1000 سکه => 25 جم (مقدارهای بسته‌شده محاسبه می‌شوند).
- ماینینگ پروفایل: نرخ ماینینگ بر اساس کارت‌های تجهیزشده محاسبه و `claim` طبق زمان گذشته عمل می‌کند.

4) نکات فرانت‌اند
- `index.html` از Alpine.js جهت فراخوانی APIها استفاده می‌کند (توابع مهم: `fetchProfile()`, `fetchPacks()`, `openPack(pack_id)`, `convertCoins()`).
- صفحات ورود/ثبت‌نام از هدر `X-CSRFToken` استفاده می‌کنند — در صورت خطای 403 بررسی کوکی CSRF لازم است.

5) اجرای محلی (خلاصه)
- نصب وابستگی‌ها: `pip install -r requirements.txt`
- اعمال مهاجرت‌ها: `python manage.py migrate`
- اجرای سرور توسعه: `python manage.py runserver` و بازدید `http://127.0.0.1:8000/`

6) کجا تغییر دهید
- افزودن/حذف پَک‌ها: از طریق ادمین یا شل Django (`Pack` rows)
- افزودن CardTemplate جدید: تنظیم `max_supply` و تصویر در `media/cards/`
- پارامترها (قیمت‌ها و نرخ‌ها): در `game/views.py` یا انتقال به `settings.py`

7) امنیت و انتشار
- قرار دادن رازها در متغیرهای محیطی، تنظیم `STATIC_ROOT` و گزینه‌های امن‌سازی Django قبل از انتشار.

8) اشکال‌زدایی
- بسته‌ها نمایش داده نمی‌شوند: بررسی وجود رکورد `Pack` و پاسخ `/api/game/packs/` و کنسول مرورگر.
- خطای 403 روی POST: بررسی CSRF.

اگر مایل هستید، می‌توانم `README.md` تولید کنم، تست سریع endpointها را اجرا کنم، یا دستور مدیریت برای ساخت پَک‌های استارتر اضافه کنم.
